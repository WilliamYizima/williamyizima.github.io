<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="bubble.css">
    <title>Bot Teste</title>
</head>

<body style="background-color:#669999;">
    <h1>Bot de Teste</h1>
    <a href="dev.html"> pular para outra página</a>
</body>

<script src="https://unpkg.com/blip-chat-widget" type="text/javascript">
</script>
<script>

    (function () {
        const chatContainer = "blip-chat-container";
        const bubbleMessage = "Olá, posso ajudar?";
        const displayClassName = "display";
        const hideClassName = "hide";
        var closeIcon;
        const iconId = "blip-chat-icon";
        const closeId = "blip-chat-close-icon";
        const topImage = "https://s3-sa-east-1.amazonaws.com/msging.net/Services/Images/c884bb06-116d-413d-aa66-aac02b28ea9c";
        const bottomImage = "https://s3-sa-east-1.amazonaws.com/infobots/fiat/customer-care/icon-white-vector.svg";
        let STARTING_COLOR = "#000000";
        const startMessage = {
            type: "text/plain",
            content: "MALWEE",
            metadata: {
                "#blip.hiddenMessage": true
            }
        }

        function createBubble() {

            bubbleContainer = document.createElement("div");
            bubbleContainer.id = "bubble-container";

            bubble = document.createElement("div");
            bubble.id = "message-bubble";
            bubble.onclick = function () { client.widget._openChat() }

            var triangle = document.createElement("div");
            triangle.id = "triangle";

            var message = document.createElement("div");
            message.id = "message";
            message.innerHTML = bubbleMessage;

            bubble.appendChild(message);
            bubble.appendChild(triangle);
            bubbleContainer.appendChild(bubble);

            document
                .querySelector(`#${chatContainer}`)
                .prepend(bubbleContainer);

        }

        function displayBubble() {
            bubble.classList.add(displayClassName);
            bubble.classList.remove(hideClassName);
        }

        function displayBubble() {
            bubble.classList.add(displayClassName);
            bubble.classList.remove(hideClassName);
        }

        function hideBubble() {
            bubble.classList.add(hideClassName);
            bubble.classList.remove(displayClassName);
        }


        changeBubble = function () {
            if (bubble.classList.contains(displayClassName))
                hideBubble();
            else
                displayBubble();
        }

        function replaceImageStructure() {

            closeIcon = document.querySelector(`#${closeId}`);
            var oldImage = document.querySelector(`#${iconId}`);

            var container = document.createElement("div");
            container.id = iconId;

            var img1 = document.createElement("img");
            img1.src = topImage;
            img1.classList.add("top")

            var img2 = document.createElement("img");
            img2.src = bottomImage;
            img2.classList.add("bottom");

            container.appendChild(img1);
            container.appendChild(img2);

            oldImage.parentElement.insertBefore(container, oldImage);
            oldImage.remove();

        }


        window.onload = function () {

            // localStorage.removeItem('blipSdkUAccount');

            // code nike
            let BASE_URL = "https://williamyizima.github.io";
            let STYLE_URL = "style.css";
            let START_SCREEN_URL = "form.html";
            let APP_KEY = "cGF1bDI6NTI0ODc0ZTMtZDkxNS00NzZlLWFmZGEtNGI2Y2RhZmU4MzAz";

            var headElement = document.getElementsByTagName("head")[0];

            var blipChatStartScreenStyleCss = document.createElement("link");
            blipChatStartScreenStyleCss.setAttribute("rel", "stylesheet");
            blipChatStartScreenStyleCss.setAttribute("type", "text/css");

            var cssLocation = STYLE_URL;

            blipChatStartScreenStyleCss.setAttribute("href", cssLocation);

            var robotoFont = document.createElement("link");
            robotoFont.setAttribute("rel", "stylesheet");
            robotoFont.setAttribute(
                "href",
                "https://fonts.googleapis.com/css?family=Roboto"
            );

            headElement.appendChild(blipChatStartScreenStyleCss);
            headElement.appendChild(robotoFont);


            var self = this;
            this._widgetLocation = "https://unpkg.com/blip-chat-widget";
            this._apiUrl = "";
            this._userIdentity = null;
            this._openClassName = "blip-chat-iframe-opened";
            this._chatConnected = false;
            this._trackSequence = [];
            this._messageSequence = [];
            this._showMainDiv = false;
            this._isLoaded = false;

            this._bubble;
            this._bubbleContainer;
            this._closeIcon;
            this._iconId = "blip-chat-icon";
            this._closeId = "blip-chat-close-icon";
            this._chatContainer = "blip-chat-container";
            this._displayClassName = "display";
            this._hideClassName = "hide";
            this._startScreenHtmlLink = START_SCREEN_URL;
            this._appKey = APP_KEY;
            this._startingColor = STARTING_COLOR;
            this._bottomImage = bottomImage;
            this._topImage = topImage;
            this._bubbleMessage = "Oi, como posso te ajudar?";
            this._maxMobileWidth = 425;
            this._maxMobileHeight = 812;
            this._blipChatLoadSuccessful = false;

            this.ToggleStartScreen = function (toHide) {
                var startScreen = document.getElementById("start-screen");
                var mainDiv = document.getElementById("blip-chat-start-screen");
                var chatOver = document.getElementById("blip-chat-button-over");

                if (mainDiv) {
                    if (toHide) {
                        startScreen.classList.add("hide");
                        mainDiv.classList.add("slide");
                        if (!self._blipChatLoadSuccessful) {
                            self._showMainDiv = true;
                        } else {
                            chatOver.classList.add("show");
                        }
                    } else {
                        startScreen.classList.remove("hide");
                        chatOver.classList.remove("show");
                        mainDiv.classList.remove("slide");
                    }
                }
            };

            // this.trackStartScreen = function () {
            //     try {
            //         var xhr = new XMLHttpRequest();
            //         xhr.open(
            //             "POST",
            //             self._apiUrl +
            //             "/utils/track/start-screen?userIdentity=" +
            //             self._userIdentity,
            //             true
            //         );
            //         xhr.send();
            //     } catch (e) {
            //         /*do nothing*/
            //     }
            // };

            // this.trackCloseStartScreen = function () {
            //     try {
            //         var xhr = new XMLHttpRequest();
            //         xhr.open(
            //             "POST",
            //             self._apiUrl +
            //             "/utils/track/close-start-screen?userIdentity=" +
            //             self._userIdentity,
            //             true
            //         );
            //         xhr.send();
            //     } catch (e) {
            //         /*do nothing*/
            //     }
            // };
            // this.enqueueTrackFunction = function (fnc) {
            //     self._trackSequence.push(fnc);

            //     if (self._userIdentity) {
            //         while (self._trackSequence.length) {
            //             var func = self._trackSequence.splice(0, 1)[0];
            //             func();
            //         }
            //     }
            // };
            
            this.sendMessage = function (msg, contentType) {
                var sendMessageFunction = function () {
                    self.sendMessage({
                        type: "text/plain",
                        content: msg,
                        metadata: {
                            sendFromStartScreen: 1,
                            contentType: contentType
                        }
                    });
                };

                if (self._chatConnected) {
                    sendMessageFunction();
                } else {
                    self._messageSequence.push(sendMessageFunction);
                }

                self.ToggleStartScreen(true);
            };
            this.processActionByElement = function (element) {
                if (!element.attributes || element.attributes.length === 0) {
                    console.log('retornando 0 process l259')
                    return 0;
                }
                var payload = element.getAttribute("payload");
                console.log('peguei um payload',payload)
                if (payload) {
                    if (payload.indexOf(":") >= 0) {
                        var payloadItems = payload.split(":");
                        var selectorId = payloadItems[payloadItems.length - 1];
                        var message = document.getElementById(selectorId).value;
                        console.log('payload:',payload)
                        if (message) {
                            self.sendMessage(message, payloadItems[0]);
                        }
                    } else {
                        self.sendMessage(payload, "click");
                    }
                    return 1;
                } else if (element.getAttribute("close-start-screen")) {
                    self.toggleIframe(false);
                    // self.enqueueTrackFunction(self.trackCloseStartScreen);
                    self.chat.widget._openChat();
                    return 1;
                }
                return 0;
            };
            document.querySelector(".subject-item").addEventListener("click", function (event) {
            
                alert('oi')
            })
            this.handler = function () {
                document.addEventListener("click", function (event) {
                    if (event.srcElement) {
                        if (self.processActionByElement(event.srcElement) === 1) {
                            return;
                        }

                        for (var j = 0; j < event.srcElement.childElementCount; j++) {
                            if (self.processActionByElement(event.srcElement.children[j]) === 1) {
                                return;
                            }
                        }
                    }

                    if (
                        event.parentElement &&
                        self.processActionByElement(event.parentElement) === 1
                    ) {
                        return;
                    }
                });

                window.addEventListener("message", function (message) {
                    if (message.data.code === "ChatConnected") {
                        self._chatConnected = true;

                        if (!self._userIdentity && localStorage.getItem("blipSdkUAccount")) {
                            var obj = JSON.parse(atob(localStorage.getItem("blipSdkUAccount")));
                            if (obj && obj.userIdentity) {
                                self._userIdentity = obj.userIdentity;
                            }
                        }

                        // if (self._userIdentity) {
                        //     while (self._trackSequence.length) {
                        //         var fnc = self._trackSequence.splice(0, 1)[0];
                        //         fnc();
                        //     }
                        // }

                        // while (self._messageSequence.length) {
                        //     var msgFnc = self._messageSequence.splice(0, 1)[0];
                        //     msgFnc();
                        // }
                    }
                });
            };
            this.isOpened = function () {
                var blipChatFrame = document.getElementById("blip-chat-open-iframe");
                return !(
                    blipChatFrame &&
                    blipChatFrame.classList &&
                    !blipChatFrame.classList.contains("opened")
                );
            };
            this.openChatBot = function () {
                if (!self.isOpened()) {
                    document.getElementById("blip-chat-open-iframe").click();
                }
            };

            this.hideChatBot = function () {
                var iframeContainer = document.getElementById("blip-chat-container");
                iframeContainer.style.display = "none";
            };

            this.showChatBot = function () {
                var iframeContainer = document.getElementById("blip-chat-container");
                iframeContainer.style.display = "block";
            };

            this.showAndOpenChatBot = function () {
                var iframeContainer = document.getElementById("blip-chat-container");
                iframeContainer.style.display = "block";
                if (!self.isOpened()) {
                    document.getElementById("blip-chat-open-iframe").click();
                }
            };

            this.hideAndCloseChatBot = function () {
                var iframeContainer = document.getElementById("blip-chat-container");
                iframeContainer.style.display = "none";
                if (self.isOpened()) {
                    document.getElementById("blip-chat-open-iframe").click();
                }
            };

            this.toggleIframe = function (visible) {
                var iframeContainer = document.getElementById("blip-chat-iframe-container");

                if (!visible) {
                    setTimeout(function () {
                        if (!self.isOpened()) {
                            setTimeout(function () {
                                iframeContainer.classList.add("hide");
                            }, 300);
                        }
                    }, 100);
                } else {
                    setTimeout(function () {
                        if (
                            iframeContainer.classList &&
                            iframeContainer.classList.contains("hide")
                        ) {
                            iframeContainer.classList.remove("hide");
                        }
                    }, 0);
                }
            };
            this.reorderIframe = function () {
                self.container = document.createElement("div");
                self.container.id = "blip-chat-iframe-container";

                document.querySelector("#blip-chat-container").append(self.container);

                self.startScreen = document.createElement("div");
                self.startScreen.id = "blip-chat-start-screen";

                self.chatOver = document.createElement("div");
                self.chatOver.id = "blip-chat-button-over";

                self.iframe = document.querySelector("#blip-chat-iframe");

                fetch(self._startScreenHtmlLink)
                    .then(function (r) {
                        return r.text();
                    })
                    .then(function (content) {
                        self.startScreen.innerHTML = content;
                        self.chatOver.innerHTML =
                            '<div id="chat-over"><div id="back-menu-icon"><img src="https://az-infobots.take.net/customercare/StaticFiles/image/back_menu.svg" alt="" /></div></div>';

                        self.container.append(self.iframe);
                        self.container.append(self.chatOver);
                        self.container.append(self.startScreen);
                    })
                    .then(function (c) {
                        console.log('passei no c')
                        document
                            .getElementById("question-input-recall")
                            .addEventListener("keyup", function (event) {
                                if (event.keyCode === 13) {
                                    console.log('enviei no question recall')
                                    event.preventDefault();
                                    document.getElementById("click-question-recall").click();
                                }
                            });

                        document
                            .getElementById("question-input")
                            .addEventListener("keyup", function (event) {
                                if (event.keyCode === 13) {
                                    console.log('enviei no click question')
                                    event.preventDefault();
                                    document.getElementById("click-question").click();
                                }
                            });

                        document
                            .getElementById("blip-chat-close-icon")
                            .addEventListener("click", function (event) {
                                self.toggleIframe(false);
                                // self.enqueueTrackFunction(self.trackCloseStartScreen);
                            });

                        document
                            .getElementById("chat-over")
                            .addEventListener("click", function (event) {
                                self.ToggleStartScreen(false);
                            });

                        document
                            .getElementById("blip-chat-open-iframe")
                            .addEventListener("click", function (event) {
                                self.toggleIframe(!self.isOpened());
                            });

                        // var scrollDownObj = document.getElementById("bottom-section");
                        // var toScrollDownObj = document.getElementsByClassName(
                        //     "start-screen-content"
                        // )[0];

                        // scrollDownObj.addEventListener("click", function (event) {
                        //     var lastScrollTopValue = 0;
                        //     var timer = setInterval(function () {
                        //         lastScrollTopValue = toScrollDownObj.scrollTop;
                        //         toScrollDownObj.scrollTop += 3;
                        //         if (toScrollDownObj.scrollTop <= lastScrollTopValue) {
                        //             clearInterval(timer);
                        //         }
                        //     }, 1);

                        //     scrollDownObj.classList.add(self._hideClassName);
                        // });

                        // toScrollDownObj.addEventListener("scroll", function (event) {
                        //     if (
                        //         toScrollDownObj.scrollHeight - toScrollDownObj.scrollTop <=
                        //         toScrollDownObj.getBoundingClientRect().height
                        //     ) {
                        //         scrollDownObj.classList.add(self._hideClassName);
                        //     }
                        // });

                        setTimeout(function () {
                            document
                                .getElementById("blip-chat-iframe")
                                .setAttribute("style", "opacity:1 !important");
                            document
                                .getElementById("start-screen")
                                .setAttribute("style", "opacity:1 !important");
                        }, 0);
                    });
            };
            this.loadBlipExtension = function () {
                return new Promise(function (resolve, reject) {
                    var script = document.createElement("script");
                    script.src = self._widgetLocation;
                    script.onload = resolve;
                    document.head.append(script);
                });
            };

            var client = new BlipChat();
            client
                .withAppKey('cGF1bDI6NTI0ODc0ZTMtZDkxNS00NzZlLWFmZGEtNGI2Y2RhZmU4MzAz')
                .withButton({ "color": "#171717", "icon": "https://s3-sa-east-1.amazonaws.com/msging.net/Services/Images/c884bb06-116d-413d-aa66-aac02b28ea9c" })
                .withCustomCommonUrl('https://chat.blip.ai/')
                .withEventHandler(BlipChat.CREATE_ACCOUNT_EVENT, function () {
                    client.sendMessage(startMessage);
                })
                .withEventHandler(BlipChat.LOAD_EVENT, function () {
                    var iframe = document.getElementById("blip-chat-iframe");
                    iframe.contentWindow.postMessage(
                        { code: "ShowCloseButton", showCloseButton: true },
                        iframe.src
                    );
                    self._blipChatLoadSuccessful = true;
                    if (self._showMainDiv) {
                        document
                            .getElementById("blip-chat-button-over")
                            .classList.add("show");
                        self._showMainDiv = false;
                    }
                })
                .withEventHandler(BlipChat.ENTER_EVENT, function () {
                    if (!self._isLoaded) {
                        self.reorderIframe();
                    } else {
                        self.ToggleStartScreen(false);
                    }
                    self._isLoaded = true;
                    // self._closeIcon.classList.add(self._displayClassName);
                    // self._closeIcon.classList.remove(self._hideClassName);
                    closeIcon.classList.add(displayClassName);
                    closeIcon.classList.remove(hideClassName);
                    hideBubble();

                    if (localStorage.getItem("blipSdkUAccount")) {
                        var obj = JSON.parse(atob(localStorage.getItem("blipSdkUAccount")));
                        if (obj && obj.userIdentity) {
                            self._userIdentity = obj.userIdentity;
                        }
                    }

                    // self.enqueueTrackFunction(self.trackStartScreen);

                    self.container.classList.add(self._openClassName);

                    self.toggleIframe(true);
                    // closeIcon.classList.add(displayClassName);
                    // closeIcon.classList.remove(hideClassName);
                    // hideBubble();
                })
                // .withEventHandler(BlipChat.ENTER_EVENT, function () {
                //     closeIcon.classList.add(displayClassName);
                //     closeIcon.classList.remove(hideClassName);
                //     hideBubble();
                // })
                .withEventHandler(BlipChat.LEAVE_EVENT, function () {
                    closeIcon.classList.add(hideClassName);
                    closeIcon.classList.remove(displayClassName);
                })
                .build();
            replaceImageStructure();
            createBubble();
            displayBubble();
            this.handler();

            setTimeout(function () {
                hideBubble();
            }, 10000);
            this.load = function () {
            self.loadBlipExtension().then(function () {
                self.loadWidget(self._appKey);
            });
            self.handler();
            };
            


        }
    })();

</script>



</html>